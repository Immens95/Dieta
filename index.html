<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dieta Dinamica per Due Persone</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 text-slate-900">

<div class="max-w-6xl mx-auto p-4 space-y-6">

  <header class="text-center">
    <h1 class="text-3xl font-bold">Dieta Dinamica</h1>
    <p class="text-slate-600">Calcolo automatico, ricette scalabili, una cucina per due</p>
  </header>

  <section id="people" class="grid md:grid-cols-2 gap-4"></section>

  <section>
    <h2 class="text-2xl font-semibold mb-2">Ricettario</h2>
    <div id="recipes" class="space-y-4"></div>
  </section>

</div>

<script>
const state = {
  people: {},
  foods: [],
  recipes: []
};

const activityMultiplier = {
  sedentary: 1.2,
  light: 1.375,
  medium: 1.55
};

function calculateBMR(p) {
  return p.sex === "male"
    ? 10 * p.weight_kg + 6.25 * p.height_cm - 5 * p.age + 5
    : 10 * p.weight_kg + 6.25 * p.height_cm - 5 * p.age - 161;
}

function calculateTargetCalories(p) {
  const bmr = calculateBMR(p);
  const tdee = bmr * activityMultiplier[p.activity_level];
  const kgToLose = p.weight_kg - p.target_weight_kg;
  const totalDeficit = kgToLose * 7700;
  const dailyDeficit = totalDeficit / (p.goal_weeks * 7);
  return Math.round(tdee - dailyDeficit);
}

function renderPeople() {
  const container = document.getElementById("people");
  container.innerHTML = "";

  Object.keys(state.people).forEach(key => {
    const p = state.people[key];
    p.targetCalories = calculateTargetCalories(p);

    container.innerHTML += `
      <div class="bg-white rounded-xl shadow p-4 space-y-2">
        <h3 class="text-xl font-semibold">${p.label}</h3>

        ${inputField(key,"age","Età",p.age)}
        ${inputField(key,"height_cm","Altezza cm",p.height_cm)}
        ${inputField(key,"weight_kg","Peso kg",p.weight_kg)}
        ${inputField(key,"target_weight_kg","Peso obiettivo kg",p.target_weight_kg)}
        ${inputField(key,"goal_weeks","Settimane obiettivo",p.goal_weeks)}

        <label class="block text-sm">Attività
          <select class="w-full border rounded p-1"
            onchange="updatePerson('${key}','activity_level',this.value)">
            ${["sedentary","light","medium"].map(v =>
              `<option value="${v}" ${p.activity_level===v?"selected":""}>${v}</option>`
            ).join("")}
          </select>
        </label>

        <div class="bg-slate-50 rounded p-2 text-sm">
          <div>BMR: <strong>${Math.round(calculateBMR(p))}</strong></div>
          <div>Kcal target: <strong>${p.targetCalories}</strong></div>
        </div>
      </div>
    `;
  });
}

function inputField(person, field, label, value) {
  return `
    <label class="block text-sm">
      ${label}
      <input type="number" class="w-full border rounded p-1"
        value="${value}"
        oninput="updatePerson('${person}','${field}',this.value)">
    </label>
  `;
}

function updatePerson(person, field, value) {
  state.people[person][field] = Number(value);
  renderPeople();
  renderRecipes();
}

function foodByName(name) {
  return state.foods.find(f => f.name === name);
}

function recipeCalories(recipe, multiplier) {
  let total = 0;
  recipe.ingredients.forEach(i => {
    const food = foodByName(i.food);
    total += (food.kcal_100 / 100) * i.grams * multiplier;
  });
  return Math.round(total);
}

function renderRecipes() {
  const container = document.getElementById("recipes");
  container.innerHTML = "";

  state.recipes.forEach(r => {
    const kcalA = recipeCalories(r, state.people.personA.targetCalories / 2000);
    const kcalB = recipeCalories(r, state.people.personB.targetCalories / 2000);

    container.innerHTML += `
      <div class="bg-white rounded-xl shadow p-4">
        <h4 class="text-lg font-semibold">${r.name}</h4>

        <div class="text-sm text-slate-600 mb-2">Modalità cucina unica</div>

        <table class="w-full text-sm mb-2">
          <thead>
            <tr class="text-left border-b">
              <th>Ingrediente</th>
              <th>A (g)</th>
              <th>B (g)</th>
              <th>Tot (g)</th>
            </tr>
          </thead>
          <tbody>
            ${r.ingredients.map(i => {
              const mA = state.people.personA.targetCalories / 2000;
              const mB = state.people.personB.targetCalories / 2000;
              const gA = Math.round(i.grams * mA);
              const gB = Math.round(i.grams * mB);
              return `
                <tr>
                  <td>${i.food}</td>
                  <td>${gA}</td>
                  <td>${gB}</td>
                  <td class="font-semibold">${gA + gB}</td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>

        <div class="flex justify-between text-sm">
          <span>Kcal A: <strong>${kcalA}</strong></span>
          <span>Kcal B: <strong>${kcalB}</strong></span>
          <span>Tot: <strong>${kcalA + kcalB}</strong></span>
        </div>
      </div>
    `;
  });
}

Promise.all([
  fetch("data/people.json").then(r => r.json()),
  fetch("data/foods.json").then(r => r.json()),
  fetch("data/recipes.json").then(r => r.json())
]).then(([people, foods, recipes]) => {
  state.people = people;
  state.foods = foods;
  state.recipes = recipes;

  renderPeople();
  renderRecipes();
});
</script>

</body>
</html>
